<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoFlow Plus | Subscription</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* Basic styling for the button */
        #buyBtn {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #3B8ED0;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        #email-section {
            display: none; /* Hidden by default until payment succeeds */
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="payment-section" style="text-align: center; margin-top: 50px;">
        <h1>Get AutoFlow Plus</h1>
        <p>Subscribe for seamless workflow continuity.</p>
        <button id="buyBtn">Subscribe Now</button>
    </div>

    <div id="email-section" style="text-align: center;">
        <h2 style="color: green;">Subscription Successful!</h2>
        <p>Enter your email to receive the license key.</p>
        <input type="email" id="userEmail" placeholder="Enter your email" required>
        <button onclick="sendLicense()">Get License</button>
    </div>

    <script>
    document.getElementById('buyBtn').onclick = async function (e) {
        e.preventDefault();

        // 1. Call the server to create a SUBSCRIPTION (not an order)
        try {
            const response = await fetch('/create-subscription', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (!data.id) {
                alert("Server error: Could not create subscription. Check Console.");
                console.error(data);
                return;
            }

            // 2. Open Razorpay Checkout
            var options = {
                "key": "rzp_live_YOUR_REAL_KEY_HERE", // <--- PASTE YOUR LIVE KEY ID HERE
                "subscription_id": data.id, // This replaces order_id
                "name": "AutoFlow Plus",
                "description": "Monthly Subscription",
                "image": "https://your-website.com/logo.png", // Optional
                "handler": async function (response) {
                    
                    // 3. Verify Payment on Server
                    const verifyRes = await fetch('/verify-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_subscription_id: response.razorpay_subscription_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    });

                    const verifyData = await verifyRes.json();

                    if (verifyData.success) {
                        // 4. Show the Email Section
                        document.getElementById('payment-section').style.display = 'none';
                        document.getElementById('email-section').style.display = 'block';
                        alert("Subscription Successful!");
                    } else {
                        alert("Payment verification failed! Please contact support.");
                    }
                },
                "prefill": {
                    "name": "",
                    "email": "",
                    "contact": ""
                },
                "theme": {
                    "color": "#3B8ED0"
                }
            };

            var rzp1 = new Razorpay(options);
            
            rzp1.on('payment.failed', function (response){
                alert("Payment Failed: " + response.error.description);
            });

            rzp1.open();

        } catch (error) {
            console.error("Error:", error);
            alert("Something went wrong. Please try again.");
        }
    }

    // Function to send the license key email
    async function sendLicense() {
        const email = document.getElementById('userEmail').value;
        if (!email) {
            alert("Please enter a valid email.");
            return;
        }

        // Generate a random license key for demo purposes
        // In a real app, you would generate this on the server or fetch from a database
        const licenseKey = 'LICENSE-' + Math.random().toString(36).substr(2, 9).toUpperCase();

        try {
            const res = await fetch('/send-license', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, licenseKey })
            });
            
            const data = await res.json();
            if (data.success) {
                alert("License key sent to " + email);
            } else {
                alert("Failed to send email.");
            }
        } catch (err) {
            console.error(err);
            alert("Error sending email.");
        }
    }
    </script>
</body>
</html>